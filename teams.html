<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<head>
    <title>Equipes Dextra</title>
</head>

<body onload="loadInitialData()">
    <nav>
        <a href="/interns">Dextragiários</a> |
        <a href="/match">Combinações</a> |
        <a href="/teams">Equipes</a>
    </nav>
    <div class="content">
        <div class="register_intern">
            <h3>Cadastro de equipes</h3>
            <p>Nesse cadastro, você poderá criar as equipes da Dextra e seus Dextragiários hipotéticos</p>
            <div class="content_username">
                <label for="teamId">Qual será o nome da equipe?</label>
                <input type="text" id="teamId" name="teamId" />
            </div>
            <div>
                <p>Quais serão os Dextragiários escolhidos?</p>
                <select id="select_intern_1">
                    <option value=""></option>
                </select>
                <select id="select_intern_2">
                    <option value=""></option>
                </select>
                <select id="select_intern_3">
                    <option value=""></option>
                </select>
                <select id="select_intern_4">
                    <option value=""></option>
                </select>
            </div>
            <input class="primary_button" type="submit" value="Criar equipe" onclick="saveTeam()">
        </div>
        <div>
            <h3>Listagem das Equipes</h3>
            <p>Nessa listagem você consegue ver os times e suas escolhas de Dextragiário que escolheu ao lado</p>
            <button onclick="getTeams()">Atualizar</button>
            <table>
                <thead>
                    <tr>
                        <th>Equipe</th>
                        <th>Dextragiários escolhidos</th>
                    </tr>
                </thead>
                <tbody id="teams_list">
                </tbody>
            </table>
        </div>
    </div>
</body>
<script>
    const urlBase = "https://mighty-mesa-64277.herokuapp.com";

    const loadInitialData = () => {
        getInternsOptions();
        getTeams();
    }

    const getTeams = () => {
        getRequest(urlBase + "/teams")
            .then(res => res.json())
            .then(teams => {
                loadTeamsTable(teams);
            })
            .catch(e => console.error("Error: ", e));
    }

    const loadTeamsTable = (teams) => {
        let teamListHTML = document.getElementById("teams_list");
        teamListHTML.innerHTML = null;
        teams.forEach(team => {
            teamListHTML.innerHTML += `<tr>`;
            teamListHTML.innerHTML += `<td>${team.teamId}</td><td>${team.internOptions}</td>`;
            teamListHTML.innerHTML += `</tr>`;
        });
    }

    const getInternsOptions = () => {
        getRequest(urlBase + "/interns")
            .then(res => res.json())
            .then(interns => loadInternsOptions(interns))
            .catch(e => console.error("Errors: ", e));
    }

    loadInternsOptions = (interns) => {
        let optionTagList;
        interns.forEach(intern => {
            optionTagList +=
                `<option value="${intern.username}">${intern.username}</option>`
        });

        document.getElementById("select_intern_1").innerHTML += optionTagList;
        document.getElementById("select_intern_2").innerHTML += optionTagList;
        document.getElementById("select_intern_3").innerHTML += optionTagList;
        document.getElementById("select_intern_4").innerHTML += optionTagList;
    }

    const saveTeam = () => {
        console.log("Save team");

        const teamId = loadTeamIdFromForms();

        let newTeam = {
            teamId: teamId,
            name: teamId,
            internNumber: 2,
            technologies: ["java", "react"],
            internOptions: loadInternsFromForms()
        }

        putRequest(urlBase + "/teams/" + teamId, newTeam)
            .then(res => res.json())
            .then(teams => {
                console.log("New teams:", teams);
                getTeams();
            })
            .catch(e => console.error("Error: ", e));
    }

    const loadTeamIdFromForms = () => {
        const teamIdText = document.getElementById("teamId").value;
        return teamIdText.toLowerCase().replace(" ", "");
    }

    const loadInternsFromForms = () => {
        const internsOptions = [];
        internsOptions.push(getInternSelectedFromHTMl("select_intern_1"));
        internsOptions.push(getInternSelectedFromHTMl("select_intern_2"));
        internsOptions.push(getInternSelectedFromHTMl("select_intern_3"));
        internsOptions.push(getInternSelectedFromHTMl("select_intern_4"));
        return internsOptions.filter(t => t != "");
    }

    const getInternSelectedFromHTMl = (id) => {
        let selectIntern = document.getElementById(id);
        return selectIntern.value;
    }

    const putRequest = (url, data) => {
        return fetch(url, {
            method: 'PUT',
            body: JSON.stringify(data),
            headers: {
                'Content-Type': 'application/json'
            }
        });
    }

    const getRequest = (url) => {
        return fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
    }

</script>
<style>
    .content {
        display: flex;
    }

    .register_intern,
    .list_interns {
        width: 50%;
        height: 100%;
    }

    .register_intern p {
        width: 80%;
    }

    .register_intern .content_username {
        display: inline-grid;
    }

    .register_intern .content_username #intern_username {
        margin-top: 10px;
    }

    button {
        margin-top: 30px;
    }

    table,
    th,
    td {
        border: 1px solid black;
    }
</style>

</html>